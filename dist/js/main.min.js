function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:22.3964,lng:114.1095},zoom:10}),service=new google.maps.places.PlacesService(map),infowindow=new google.maps.InfoWindow({maxWidth:300}),viewModel.updateAllPlaceInfo()}function showInfoWindow(e){$(".row-offcanvas").removeClass("active"),viewModel.showInfoWindow(e)}function highlightMarker(e){var o=viewModel.getMarker(e);void 0!==o&&(viewModel.setIconColor(e,"yellow"),viewModel.moveMarkerToFront(o,!0))}function undoHighlightMarker(e){var o=viewModel.getMarker(e);void 0!==o&&(viewModel.setIconColor(e,"red"),viewModel.moveMarkerToFront(o,!1))}function showFailedToLoadGoogleMapsAlert(){alert("Failed to load Google Maps")}var map,service,infowindow,redMarker="https://maps.google.com/mapfiles/ms/icons/red-dot.png",yellowMarker="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",warningMarker="https://maps.google.com/mapfiles/kml/pal3/icon33.png",viewModel,Place=function(e){var o=this;this.id=ko.observable(""),this.name=e,this.location={lat:0,lng:0},this.description=ko.observable(""),this.photo=ko.observable(""),this.icon=ko.observable(""),this.tooltip=ko.computed(function(){if(""===this.id())return this.icon()===warningMarker?"Failed to get data from Google Maps":"Trying to get data from Google Maps"},this),this.visibility=ko.observable(!0),this.infoWindowContent=ko.computed(function(){var e;e=""===this.photo()?"":'<img src="'+this.photo()+'" alt="'+this.name+'" style="max-width: 100%">';var o=e+"<h3>"+this.name+"</h3><div>"+this.description()+"</div>";return o},this),$.ajax({url:"https://en.wikipedia.org/w/api.php",dataType:"jsonp",data:{action:"query",format:"json",prop:"extracts",exsentences:"3",titles:o.name}}).done(function(e){if(void 0===e.query)return void o.description("<p>No article related to "+o.name+" can be found in Wikipedia.</p>");var i=e.query.pages;for(var a in i)if(i.hasOwnProperty(a)){var t=i[a].extract;return void o.description(t+'<p class="infowindow-url-wiki">from <a href="https://en.wikipedia.org/?curid='+a+' target="_blank">Wikipedia</a></p>')}o.description("<p>No article related to "+o.name+" can be found in Wikipedia.</p>")}).fail(function(e){var i="Failed to get article related to "+o.name+" from Wikipedia.";o.description("<p>"+i+"</p>"),console.log(i)})},ViewModel=function(){var e=this;this.places=ko.observableArray([]),this.filter=ko.observable(""),this.placeToMarkerMappings=[],this.filter.subscribe(function(o){e.updatePlaceVisibilities()}),$.ajax({url:"places.json",dataType:"json"}).done(function(o){var i=o.places;i.forEach(function(o){var i=new Place(o);e.places.push(i),i.id.subscribe(function(){e.addMarker(i)}.bind(i)),void 0!==map&&setTimeout(function(){e.updateSinglePlaceInfo(i)},100*e.places().indexOf(i))})}).fail(function(e){alert("Failed to get the list of places from server")}),this.updatePlaceVisibilities=function(){var o=e.filter().toLocaleUpperCase();e.places().forEach(function(i){var a=i.name.toLocaleUpperCase();i.visibility(a.includes(o));var t=e.getMarker(i);void 0!==t&&(i.visibility()===!0?e.showMarker(t):e.hideMarker(t))})},this.updateSinglePlaceInfo=function(o){""===o.id()&&service.textSearch({query:o.name},function(i,a){a===google.maps.places.PlacesServiceStatus.OK?(o.location={lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng()},i[0].hasOwnProperty("photos")&&o.photo(i[0].photos[0].getUrl({maxWidth:300})),o.icon(redMarker),o.id(i[0].place_id)):a===google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT?setTimeout(function(){e.updateSinglePlaceInfo(o)},2e3):(o.icon(warningMarker),console.log("Failed to get info of "+o.name+" from Google Maps."))})},this.getMarker=function(o){for(var i=0;i<e.placeToMarkerMappings.length;i++){var a=e.placeToMarkerMappings[i];if(a.place===o)return a.marker}},this.updateAllPlaceInfo=function(){e.places().forEach(function(o){var i=e.getMarker(o);void 0===i&&setTimeout(function(){e.updateSinglePlaceInfo(o)},100*e.places().indexOf(o))})},this.setIconColor=function(e,o){switch(o){case"red":e.icon(redMarker);break;case"yellow":e.icon(yellowMarker);break;default:console.log(o+" is not a valid icon color")}},this.moveMarkerToFront=function(e,o){void 0!==e&&(o===!0?e.setZIndex(e.getZIndex()+1):e.setZIndex(e.getZIndex()-1))},this.addMarker=function(o){var i=o.id(),a=o.name,t=new google.maps.LatLng(o.location.lat,o.location.lng),n=o.icon(),r=new google.maps.Marker({id:i,title:a,position:t,animation:google.maps.Animation.DROP,icon:n,zIndex:0});o.icon.subscribe(function(e){r.setIcon(e)}),r.addListener("click",function(){infowindow.setContent(o.infoWindowContent()),infowindow.open(map,r),r.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){r.setAnimation(null)},700)}),r.addListener("mouseover",function(){e.setIconColor(o,"yellow"),e.moveMarkerToFront(r,!0)}),r.addListener("mouseout",function(){e.setIconColor(o,"red"),e.moveMarkerToFront(r,!1)}),r.setMap(map),e.placeToMarkerMappings.push({place:o,marker:r}),o.visibility()===!0?e.showMarker(r):e.hideMarker(r)},this.showInfoWindow=function(o){var i=e.getMarker(o);void 0!==i&&google.maps.event.trigger(i,"click")},this.showMarker=function(e){e.setVisible(!0)},this.hideMarker=function(e){e.setVisible(!1)}};viewModel=new ViewModel,ko.applyBindings(viewModel),$(document).ready(function(){$('[data-toggle="offcanvas"]').click(function(){$(".row-offcanvas").toggleClass("active")})});