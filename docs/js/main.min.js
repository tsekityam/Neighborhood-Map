function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:22.3964,lng:114.1095},zoom:10}),service=new google.maps.places.PlacesService(map),viewModel.updateAllPlaceInfo()}function showInfoWindow(e){$(".row-offcanvas").removeClass("active"),viewModel.showInfoWindow(e)}function highlightMarker(e){var o=viewModel.getMarker(e);void 0!==o&&(viewModel.setIconColor(e,"yellow"),viewModel.moveMarkerToFront(o,!0))}function undoHighlightMarker(e){var o=viewModel.getMarker(e);void 0!==o&&(viewModel.setIconColor(e,"red"),viewModel.moveMarkerToFront(o,!1))}var map,service,viewModel,Place=function(e){var o=this;this.id=ko.observable(""),this.name=ko.observable(e),this.location=ko.observable({lat:0,lng:0}),this.wikiExtracts=ko.observable(""),this.wikiPageID=ko.observable(""),this.wikiUrl=ko.computed(function(){return"https://en.wikipedia.org/?curid="+this.wikiPageID()},this),this.photo=ko.observable(""),this.icon=ko.observable(""),this.visibility=ko.observable(!0),this.infoWindowContent=ko.computed(function(){var e;e=""===this.photo()?"":'<img src="'+this.photo()+'" alt="'+this.name()+'" style="max-width: 100%">';var o;o=""===this.wikiPageID()?"":'<p class="infowindow-url-wiki">from <a href="'+this.wikiUrl()+'" target="_blank">Wikipedia</a></p>';var i=e+"<h3>"+this.name()+"</h3><div>"+this.wikiExtracts()+o+"</div>";return i},this),$.ajax({url:"https://en.wikipedia.org/w/api.php",dataType:"jsonp",data:{action:"query",format:"json",prop:"extracts",exsentences:"3",titles:o.name()}}).done(function(e){if(void 0===e.query)return void console.log("fail to get extracts from wikipedia.");var i=e.query.pages;for(var t in i)if(i.hasOwnProperty(t)){var n=i[t].extract;if(o.wikiPageID(t),void 0!==n)return void o.wikiExtracts(n)}}).fail(function(e){console.log("fail to get extracts from wikipedia.")})},ViewModel=function(){var e=this;this.places=ko.observableArray([]),this.filter=ko.observable(""),this.lastOpenedInfoWindow,this.placeToMarkerMappings=[],this.filter.subscribe(function(o){e.updatePlaceVisibilities()}),$.ajax({url:"places.json"}).done(function(o){var i=o.places;i.forEach(function(o){var o=new Place(o);e.places.push(o),o.id.subscribe(function(){e.addMarker(o)}.bind(o)),void 0!==map&&setTimeout(function(){e.updateSinglePlaceInfo(o)},100*e.places().indexOf(o))})}).fail(function(e){console.log("fail to get places.")}),this.updatePlaceVisibilities=function(){var o=e.filter().toLocaleUpperCase();e.places().forEach(function(i){var t=i.name().toLocaleUpperCase();i.visibility(t.includes(o));var n=e.getMarker(i);void 0!==n&&(i.visibility()===!0?e.showMarker(n):e.hideMarker(n))})},this.updateSinglePlaceInfo=function(o){""===o.id()&&service.textSearch({query:o.name()},function(i,t){t===google.maps.places.PlacesServiceStatus.OK?(o.location({lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng()}),i[0].hasOwnProperty("photos")&&o.photo(i[0].photos[0].getUrl({maxWidth:300})),o.icon("https://maps.google.com/mapfiles/ms/icons/red-dot.png"),o.id(i[0].place_id)):google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT?setTimeout(function(){e.updateSinglePlaceInfo(o)},2e3):console.log("failed to get info of "+o.name()+" from Google Maps")})},this.getMarker=function(o){for(var i=0;i<e.placeToMarkerMappings.length;i++){var t=e.placeToMarkerMappings[i];if(t.place===o)return t.marker}},this.updateAllPlaceInfo=function(){void 0!==map&&e.places().forEach(function(o){var i=e.getMarker(o);void 0===i&&setTimeout(function(){e.updateSinglePlaceInfo(o)},100*e.places().indexOf(o))})},this.setIconColor=function(e,o){switch(o){case"red":e.icon("https://maps.google.com/mapfiles/ms/icons/red-dot.png");break;case"yellow":e.icon("https://maps.google.com/mapfiles/ms/icons/yellow-dot.png");break;default:console.log(o+" is not a valid icon color")}},this.moveMarkerToFront=function(e,o){void 0!==e&&(o===!0?e.setZIndex(e.getZIndex()+1):e.setZIndex(e.getZIndex()-1))},this.addMarker=function(o){var i=o.id(),t=o.name(),n=new google.maps.LatLng(o.location().lat,o.location().lng),a=o.icon(),s=o.infoWindowContent(),r=new google.maps.InfoWindow({content:s,maxWidth:300});o.infoWindowContent.subscribe(function(e){r.setContent(e)});var l=new google.maps.Marker({id:i,title:t,position:n,animation:google.maps.Animation.DROP,icon:a,zIndex:0});o.icon.subscribe(function(e){l.setIcon(e)}),l.addListener("click",function(){void 0!==e.lastOpenedInfoWindow&&e.lastOpenedInfoWindow.close(),r.open(map,l),l.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){l.setAnimation(null)},700),e.lastOpenedInfoWindow=r}),l.addListener("click",function(){void 0!==e.lastOpenedInfoWindow&&e.lastOpenedInfoWindow.close(),r.open(map,l),l.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){l.setAnimation(null)},700),e.lastOpenedInfoWindow=r}),l.addListener("visible_changed",function(){r.close()}),l.addListener("mouseover",function(){e.setIconColor(o,"yellow"),e.moveMarkerToFront(l,!0)}),l.addListener("mouseout",function(){e.setIconColor(o,"red"),e.moveMarkerToFront(l,!1)}),l.setMap(map),e.placeToMarkerMappings.push({place:o,marker:l})},this.showInfoWindow=function(o){var i=e.getMarker(o);void 0!==i&&new google.maps.event.trigger(i,"click")},this.showMarker=function(e){e.setVisible(!0)},this.hideMarker=function(e){e.setVisible(!1)}};viewModel=new ViewModel,ko.applyBindings(viewModel),$(document).ready(function(){$('[data-toggle="offcanvas"]').click(function(){$(".row-offcanvas").toggleClass("active")})});